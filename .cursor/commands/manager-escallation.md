# Manager: Engineer エスカレーション対応ワークフロー

## ゴール

- Engineer から「行き詰まり」としてエスカレーションされた Issue について、
  - 何がボトルネックか（要件の不明瞭さ / テストの誤り / 技術的難易度など）を整理し、
  - 必要な調整（Issue 更新・Architect への再依頼・方針提案）を行う。
- 最後に、Engineer が再開できる状態まで持って行き、ユーザーに Engineer 呼び出しを促す。

---

## 手順 1: Issue とコメント内容を把握する

1. ユーザーから対象 Issue 番号を受け取る（例: `#42`）。
2. `gh-manager issue view <issue_number>` で、
   - タイトル
   - ラベル（`task` / `setup` / `refactor` など）
   - 説明
   - Requirements（R1, R2, ...）
   - Acceptance Criteria
   を確認する。
3. Engineer が残した「行き詰まり報告」のコメントを読み、
   - どのコマンド / テストが失敗しているか
   - 何を試したか
   - どのような仮説や代替案を持っているか
   を簡潔に把握する。

---

## 手順 2: 問題の種類を見立てる

次のどれに近いかを判定する：

1. **要件・設計の問題**
   - docs/ の記述が曖昧・矛盾している。
   - Acceptance Criteria が不適切（実現不能 / 要件とズレている）。
2. **テスト設計の問題**
   - テストケースが要件と一致していない。
   - 実装として正しそうだが、テストの期待値がおかしい。
3. **実装アプローチの問題**
   - 要件・テストは妥当だが、Engineer のアプローチが非効率 / 複雑すぎる / 問題に適していない。
4. **本質的な技術的難易度**
   - 問題自体が難しく、追加の設計分解や段階的なタスク分割が必要。

---

## 手順 3: 対応方針を決めて反映する

### 3-A. 要件・設計の問題の場合

1. docs/（`docs/REQUIREMENT.md`, `docs/USE_CASES.md`, `docs/DOMAIN_ER.md` など）を読み、
   - どの部分の解釈が曖昧か、どのように読むべきかを自分なりに整理する。
2. 現在の Issue の Requirements / Acceptance Criteria がその解釈とズレている場合、
   - 「どう書き換えるべきか（どの Rn をどう変更するか）」を文章でまとめる。
3. 軽微な修正であれば、`gh-manager issue edit` とコメントを使い、
   - Requirements / Acceptance Criteria を直接更新し、
   - 「どのような前提で実装を進めてほしいか」をコメントで明示する。
4. 大きめの設計変更や docs/ の広範な修正が必要な場合は、
   - 「docs/ 更新専用の Issue（task）」を新たに作成し、
   - 現在の Issue コメントに「当面どの仕様を前提に進めるか」を書いておく。

### 3-B. テスト設計の問題の場合

1. docs/ と Issue の Requirements / Acceptance Criteria を突き合わせ、
   - 正しい振る舞いがどうあるべきかを明文化する。
2. テストをどう修正すべきか（対象ケース・期待値・境界条件など）を具体的に提案し、
   - Issue コメントとして残す。
3. 必要に応じて、「テスト修正専用の小さなサブタスク Issue」を新たに作ることも検討する。

### 3-C. 実装アプローチ / 技術的難易度の問題の場合

1. Engineer が試したアプローチを整理し、
   - どこがボトルネックか（計算量 / 設計の複雑さ / ライブラリ選定など）を言語化する。
2. docs/ と Issue のスコープを見直し、
   - タスクをもう少し細かく分解するべきか、
   - Acceptance Criteria を段階的にするべきかを判断する。
3. 具体的な Next Step を Issue コメントとして示す：
   - 例: 「まず部分問題 X だけを解く小タスクに分ける」「アルゴリズム B に切り替える」など。
4. 必要なら、新しい `task` / `refactor` Issue を作成する。

---

## 手順 4: Engineer への戻し方

1. 上記いずれのケースでも、
   - 「現在の判断」と
   - 「Engineer にやってほしい次の具体的な作業内容」
   を Issue コメントとして残す。
2. そのうえで、ユーザーに Engineer を呼び出すためのアクションブロックを提示する：

   ```md
   ::: action 🛑 User Action Required
   **Status:** Engineer Escalation Resolved (Next Step Defined)
   **Next Step:** すでに利用している Engineer 用チャットを開き、以下のプロンプトをそのまま送信してください。
   **Next Prompt:**
   > Issue #<issue_number> の行き詰まりに対して、Manager から次の方針がコメントされています。  
   > Issue コメントを読み、指示に従って作業を再開してください。
   :::
   ```